<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ó–æ–±—Ä–∞–∂–µ–Ω—å –∑–∞ –¢–µ–∫—Å—Ç–æ–º (Imagen)</title>
    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Tailwind CSS –¥–ª—è —Å—Ç–∏–ª—ñ–∑–∞—Ü—ñ—ó -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* –°—Ç–∏–ª—å –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –≥–∞—Ä–Ω–æ–≥–æ –≤–∏–≥–ª—è–¥—É –Ω–∞ –≤—Å—ñ—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
    </style>
</head>
<body>

    <div class="container py-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ó–æ–±—Ä–∞–∂–µ–Ω—å üé®</h1>
            <p class="text-lg text-gray-600">–°—Ç–≤–æ—Ä—ñ—Ç—å –±—É–¥—å-—è–∫–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ–ø–∏—Å—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –º–æ–¥–µ–ª—å Imagen.</p>
        </header>

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –ø—Ä–æ–º–ø—Ç–∞ -->
        <div class="bg-white p-6 rounded-xl shadow-2xl mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <input
                    type="text"
                    id="promptInput"
                    placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: '–ö—ñ—Ç-–∞—Å—Ç—Ä–æ–Ω–∞–≤—Ç —É —Å—Ç–∏–ª—ñ –ø—ñ–∫—Å–µ–ª—å-–∞—Ä—Ç –Ω–∞ –ú–∞—Ä—Å—ñ, –≤–∏—Å–æ–∫–∞ –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è'"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                >
                <button
                    id="generateButton"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 disabled:opacity-50"
                    onclick="generateImage()"
                >
                    –°—Ç–≤–æ—Ä–∏—Ç–∏ –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                </button>
            </div>
            <p id="error-message" class="text-red-500 mt-2 text-sm hidden"></p>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞ —Å—Ç–∞—Ç—É—Å—É -->
        <div class="bg-white p-6 rounded-xl shadow-2xl min-h-[400px] flex items-center justify-center relative">
            
            <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á (Loading Spinner) -->
            <div id="loadingIndicator" class="flex flex-col items-center justify-center hidden">
                <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-indigo-600 font-semibold">–ì–µ–Ω–µ—Ä—É—é –º–∞–≥—ñ—é... –ó–∞—á–µ–∫–∞–π—Ç–µ.</p>
            </div>

            <!-- –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è -->
            <img id="generatedImage" src="" alt="–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ Imagen" class="max-w-full h-auto rounded-lg shadow-lg" style="display:none;">

            <!-- –ü–æ—á–∞—Ç–∫–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
            <p id="initialMessage" class="text-gray-500 italic">–í–∞—à–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑'—è–≤–∏—Ç—å—Å—è —Ç—É—Ç.</p>

        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è Firestore —Ç–∞ API
        const apiKey = ""; // –ö–ª—é—á API –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –ø–æ—Ä–æ–∂–Ω—ñ–º, –≤—ñ–Ω –±—É–¥–µ –Ω–∞–¥–∞–Ω–∏–π —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ–º Canvas
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;

        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ DOM
        const promptInput = document.getElementById('promptInput');
        const generateButton = document.getElementById('generateButton');
        const generatedImage = document.getElementById('generatedImage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const initialMessage = document.getElementById('initialMessage');
        const errorMessage = document.getElementById('error-message');

        /**
         * –£—Ç–∏–ª—ñ—Ç–∞ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è fetch-–∑–∞–ø–∏—Ç—É –∑ –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–∏–º –≤—ñ–¥—Å—Ç—É–ø–æ–º (backoff)
         * –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –º–æ–∂–ª–∏–≤–∏—Ö –ø–æ–º–∏–ª–æ–∫ –æ–±–º–µ–∂–µ–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ.
         * @param {string} url - URL –¥–ª—è –∑–∞–ø–∏—Ç—É.
         * @param {object} options - –û–ø—Ü—ñ—ó –∑–∞–ø–∏—Ç—É fetch.
         * @param {number} maxRetries - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö —Å–ø—Ä–æ–±.
         * @returns {Promise<Response>}
         */
        async function fetchWithExponentialBackoff(url, options, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ 429 (Too Many Requests)
                    if (response.status === 429) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        console.warn(`–û—Ç—Ä–∏–º–∞–Ω–æ 429. –ü–æ–≤—Ç–æ—Ä–Ω–∞ —Å–ø—Ä–æ–±–∞ —á–µ—Ä–µ–∑ ${Math.round(delay / 1000)}—Å...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    // –î–ª—è —ñ–Ω—à–∏—Ö –ø–æ–º–∏–ª–æ–∫, —è–∫—ñ –Ω–µ —î 429, –∫–∏–¥–∞—î–º–æ –ø–æ–º–∏–ª–∫—É
                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ API: ${response.status} ${response.statusText}`);

                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error; // –í–∏–∫–∏–¥–∞—î–º–æ –ø–æ–º–∏–ª–∫—É –ø—ñ—Å–ª—è –æ—Å—Ç–∞–Ω–Ω—å–æ—ó —Å–ø—Ä–æ–±–∏
                    }
                    // –û–±—Ä–æ–±–∫–∞ –º–µ—Ä–µ–∂–µ–≤–∏—Ö –ø–æ–º–∏–ª–æ–∫ –∞–±–æ –ø–æ–º–∏–ª–æ–∫ fetch
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    console.error(`–ú–µ—Ä–µ–∂–µ–≤–∞ –ø–æ–º–∏–ª–∫–∞. –ü–æ–≤—Ç–æ—Ä–Ω–∞ —Å–ø—Ä–æ–±–∞ —á–µ—Ä–µ–∑ ${Math.round(delay / 1000)}—Å...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.
         */
        async function generateImage() {
            const userPrompt = promptInput.value.trim();

            if (!userPrompt) {
                errorMessage.textContent = '–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –æ–ø–∏—Å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.';
                errorMessage.classList.remove('hidden');
                return;
            }

            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É —Ç–∞ –ø–æ—á–∞—Ç–∫–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            errorMessage.classList.add('hidden');
            initialMessage.style.display = 'none';
            generatedImage.style.display = 'none';
            
            // –í–º–∏–∫–∞—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –≤–∏–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É
            loadingIndicator.classList.remove('hidden');
            generateButton.disabled = true;

            const payload = {
                instances: [{ prompt: userPrompt }],
                parameters: {
                    "sampleCount": 1,
                    "aspectRatio": "1:1" // –ö–≤–∞–¥—Ä–∞—Ç–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                }
            };

            try {
                // –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É –¥–æ Imagen API
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    
                    // –§–æ—Ä–º—É–≤–∞–Ω–Ω—è URL –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    
                    // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                    generatedImage.src = imageUrl;
                    generatedImage.alt = userPrompt; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø—Ä–æ–º–ø—Ç —è–∫ alt —Ç–µ–∫—Å—Ç
                    generatedImage.style.display = 'block';

                } else {
                    // –û–±—Ä–æ–±–∫–∞ –≤–∏–ø–∞–¥–∫—É, –∫–æ–ª–∏ API –ø–æ–≤–µ—Ä–Ω—É–ª–æ –ø–æ–º–∏–ª–∫—É –∞–±–æ –Ω–µ –∑–≥–µ–Ω–µ—Ä—É–≤–∞–ª–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                    const errorDetails = result.error?.message || "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –æ–ø–∏—Å.";
                    errorMessage.textContent = `–ü–æ–º–∏–ª–∫–∞: ${errorDetails}`;
                    errorMessage.classList.remove('hidden');
                    initialMessage.style.display = 'block'; // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—á–∞—Ç–∫–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                }

            } catch (error) {
                // –û–±—Ä–æ–±–∫–∞ –º–µ—Ä–µ–∂–µ–≤–∏—Ö –∞–±–æ –Ω–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–∫–ª–∏–∫—É Gemini API:", error);
                errorMessage.textContent = `–ù–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–∞ –ø–æ–º–∏–ª–∫–∞: ${error.message}. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`;
                errorMessage.classList.remove('hidden');
                initialMessage.style.display = 'block'; // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—á–∞—Ç–∫–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            } finally {
                // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –≤–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É
                loadingIndicator.classList.add('hidden');
                generateButton.disabled = false;
            }
        }
    </script>

</body>
</html>